<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xanadubox</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase client - config will be loaded from server
        let supabaseClient = null;
        
        async function initSupabase() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                window.SUPABASE_CONFIG = config;
                supabaseClient = supabase.createClient(config.url, config.anonKey);
                console.log('Supabase client initialized');
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
            }
        }
        
        // Initialize on page load
        initSupabase();
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>xanadubox</h1>
            <p id="confuciusQuote">Loading wisdom...</p>
        </header>

        <!-- Floating Action Buttons -->
        <div class="floating-buttons">
            <button class="floating-btn admin-btn" onclick="openAdminModal()" title="Admin Panel">
                settings
            </button>
            <button class="floating-btn tracklist-btn" onclick="openTracklistModal()" title="Tracklist Database">
                tracklist db
            </button>
        </div>

        <main>
            <!-- Data Processing Section -->
            <section class="processing-section" id="processingSection" style="display: none;">
                <h3>find matches in uploaded file</h3>
                <div class="mapping-controls">
                    <div class="mapping-item">
                        <label for="artistNames">artist names (comma or newline separated):</label>
                        <textarea id="artistNames" rows="4" placeholder="enter here"></textarea>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="process-btn" id="findBtn" onclick="findMatches()">find matches</button>
                        <button class="download-btn" id="downloadCsvBtn" onclick="downloadCSV()" disabled>download csv</button>
                        <button class="reset-btn" onclick="resetApp()">cancel</button>
                    </div>
                    <div id="summary" style="margin-top:12px; color:#4a5568;"></div>
                    <div id="progress" style="margin-top:8px; color:#718096; font-size:0.95rem;"></div>
                </div>
            </section>

            <!-- Results Display Section -->
            <section class="results-display" id="resultsDisplay" style="display: none;">
                <div class="results-header">
                    <h3>search results</h3>
                    <div class="format-toggles">
                        <button class="format-btn active" onclick="setResultFormat('table')" id="tableFormatBtn">Table View</button>
                        <button class="format-btn" onclick="setResultFormat('station')" id="stationFormatBtn">Station Format</button>
                        <button class="format-btn" onclick="setResultFormat('spingrid')" id="spingridFormatBtn">Spingrid</button>
                    </div>
                </div>
                
                <!-- Table Format -->
                <div id="tableFormat" class="result-format">
                    <div class="results-table-container">
                        <table id="resultsTable" class="results-table">
                            <thead>
                                <tr>
                                    <th>station</th>
                                    <th>artist</th>
                                    <th>song</th>
                                    <th>actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Station Format -->
                <div id="stationFormat" class="result-format" style="display: none;">
                    <div class="results-text-container">
                        <div id="stationResultsBody"></div>
                    </div>
                </div>
                
                <!-- Spingrid Format -->
                <div id="spingridFormat" class="result-format" style="display: none;">
                    <div class="format-actions">
                        <button class="download-btn" onclick="copySpingridForExcel()">copy for excel</button>
                    </div>
                    <div class="results-text-container">
                        <div id="spingridResultsBody"></div>
                    </div>
                </div>
            </section>

            <!-- Spinitron Formatter Section -->
            <section class="load-section" id="loadSection">
                <h3>spinitron formatter</h3>
                <p>upload a spinitron file with spin data to format and analyze.</p>
                <input type="file" id="csvFile" accept=".csv,text/csv,application/vnd.ms-excel" style="display: none;" onchange="handleCsvUpload()">
                <button class="process-btn" onclick="document.getElementById('csvFile').click()">click to upload</button>
            </section>
        </main>

        <!-- Admin Modal -->
        <div id="adminModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>admin panel</h3>
                    <button class="close-btn" onclick="closeAdminModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="admin-controls">
                        <input type="password" id="adminPassword" placeholder="admin password">
                        <input type="file" id="adminFile" accept=".xlsx,.xls" title="Upload Online Radio Box file">
                        <button class="process-btn" onclick="adminUpload()">upload/replace</button>
                        <button class="reset-btn" onclick="adminDelete()">delete</button>
                        <button class="download-btn" onclick="adminRefreshStatus()">refresh status</button>
                    </div>
                    <div id="adminStatus" class="admin-status"></div>
                </div>
            </div>
        </div>

        <!-- Tracklist Modal -->
        <div id="tracklistModal" class="modal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>tracklist database</h3>
                    <button class="close-btn" onclick="closeTracklistModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="tracklist-controls">
                        <div class="tracklist-input">
                            <label for="artistName">artist name:</label>
                            <input type="text" id="artistName" placeholder="enter artist name">
                        </div>
                        <div class="tracklist-input">
                            <label for="songName">song name:</label>
                            <input type="text" id="songName" placeholder="enter song name">
                        </div>
                        <div class="tracklist-actions">
                            <button class="process-btn" onclick="addSongToTracklist()">add song</button>
                        </div>
                    </div>
                    
                    <div class="tracklist-bulk-add">
                        <h4>bulk add songs</h4>
                        <div class="bulk-add-controls">
                            <div class="tracklist-input">
                                <label for="bulkArtistName">artist name:</label>
                                <input type="text" id="bulkArtistName" placeholder="enter artist name">
                            </div>
                            <div class="tracklist-input">
                                <label for="bulkSongNames">song names (one per line):</label>
                                <textarea id="bulkSongNames" rows="4" placeholder="enter song names, one per line:&#10;Song 1&#10;Song 2&#10;Song 3"></textarea>                                                       
                            </div>
                            <div class="tracklist-actions">
                                <button class="download-btn" onclick="addMultipleSongs()">add all songs</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tracklist-display">
                        <div class="tracklist-header">
                            <h4>current tracklists</h4>
                            <div class="search-container">
                                <input type="text" id="tracklistSearch" placeholder="search artists..." onkeyup="filterTracklists()">
                                <button class="clear-search-btn" onclick="clearTracklistSearch()" title="clear search">Ã—</button>
                            </div>
                        </div>
                        <div id="tracklistContainer" class="tracklist-container">
                            <!-- Tracklists will be displayed here -->
                        </div>
                    </div>
                    
                    <div class="tracklist-import">
                        <h4>import/export</h4>
                        <div class="import-export-controls">
                            <button class="process-btn" onclick="exportTracklists()">export database</button>                                                                                                          
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTracklists()">                                                                                    
                            <button class="download-btn" onclick="document.getElementById('importFile').click()">import database</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variant Modal -->
        <div id="variantModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>select parent track</h3>
                    <button class="close-btn" onclick="closeVariantModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="variant-info">
                        <p><strong>Making variant:</strong> <span id="variantTrackInfo"></span></p>
                        <p style="color: #718096; font-size: 0.9em; margin-top: 10px;">Select the parent track this should be grouped under in the spingrid view.</p>
                    </div>
                    <div id="variantTracklistContainer" class="variant-tracklist-container">
                        <!-- Tracklist will be displayed here -->
                    </div>
                    <div class="variant-actions" style="margin-top: 20px;">
                        <button class="reset-btn" onclick="clearVariant()">Clear Variant</button>
                        <button class="process-btn" onclick="saveVariant()">Save Variant</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
